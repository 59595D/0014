name: Create GitHub Release

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release tag name'
        required: true
        default: 'v1.0.0'
      release_name:
        description: 'Release name'
        required: true
        default: 'æ”¶çº³ App v1.0.0'
      body:
        description: 'Release description'
        required: false
        default: 'Android æ”¶çº³ App æ­£å¼å‘å¸ƒç‰ˆæœ¬'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: é…ç½® Gradle ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: æ„å»º Release APK
        run: ./gradlew assembleRelease --stacktrace

      - name: ç­¾å Release APK
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > app/release-keystore.jks
            ./gradlew assembleRelease \
              -Pandroid.injected.signing.store.file=app/release-keystore.jks \
              -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
              -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
              -Pandroid.injected.signing.key.password=$KEY_PASSWORD
          fi

      - name: ç”Ÿæˆ APK ä¿¡æ¯
        id: apk_info
        run: |
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "ğŸ“± APK å¤§å°: $APK_SIZE"

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          name: ${{ github.event.inputs.release_name }}
          body: |
            ${{ github.event.inputs.body }}

            ### ğŸ“¥ ä¸‹è½½
            - **app-release.apk** - å®‰è£…åŒ… (å¤§å°: ${{ steps.apk_info.outputs.size }})
            - **app-release-keystore.apk** - ç­¾åç‰ˆå®‰è£…åŒ… (å¦‚æœé…ç½®äº†ç­¾å)

            ### ğŸ“± å®‰è£…è¯´æ˜
            1. ä¸‹è½½ APK æ–‡ä»¶åˆ°æ‰‹æœº
            2. å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨
            3. ç‚¹å‡» APK æ–‡ä»¶è¿›è¡Œå®‰è£…

            ### ğŸ¯ ä¸»è¦åŠŸèƒ½
            - âœ… ç‰©å“ç™»è®°ç®¡ç†
            - âœ… é¦–é¡µæ€»è§ˆ
            - âœ… æŸ¥è¯¢æµè§ˆ
            - âœ… ç‰©å“è¯¦æƒ…
            - âœ… ä¿è´¨æœŸæé†’
            - âœ… è¯­éŸ³è¯†åˆ«
            - âœ… å›¾ç‰‡é€‰æ‹©
            - âœ… æŠ˜å å±é€‚é…

            ### ğŸ’¡ æ„å»ºä¿¡æ¯
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - æäº¤: ${{ github.event.head_commit.message }}
            - æäº¤è€…: ${{ github.event.head_commit.author.name }}

          files: |
            app/build/outputs/apk/release/*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
